### 微信扫码登录

1. 获取二维码：
  
  - 登录端请求二维码接口
  - 服务端生成二维码记录存入db，并放入缓存（如redis），设置 TTL，返回二维码，假设码中携带对应 token A

2. 展示二维码：

  - 登录端展示二维码，同时开始轮询后端 A 对应状态是否被扫码确认
  - 超时则定时刷新二维码或提示已失效
  - 已扫码，状态变为“已扫码”，甚至可以展示xxx已扫码
  - 如果已经确认登录，则返回“已确认”，并携带登录端使用的 session token C

3. 登录确认：

  - 扫描二维码，确认是否授权操作；是则生成对应临时 token K，并展示授权登录界面；K 的存在是为了保证是同一个手机确认的，换手机则 K 不存在
  - 确认登录，则携带 K 请求服务端
  - 服务端根据 K查询到 A，并将对应登录操作置为已确认，生成并返回当前用户登录端 session token C
  - 如果失效过期，则登录失败

5. 登录流程结束

  - 登录端轮询到 token A 对应状态已经变更，并获取到 session token C，则后续使用 C 进行通信

6. 其他

  - 轮询优化，比如通过长轮询来减少轮询次数，仅当扫码状态变化时返回响应（比如15s）

### 第三方微信 oauth登录

1. 配置微信 oauth 授权域名等
2. 访问本服务授权链接并携带必要参数，302 重定向到微信 oauth 登录二维码扫描确认页面，携带重要参数如 redirect_url 等
3. 访问微信 oauth 授权url，则会展示二维码（二维码扫描参考上个场景：微信扫码登录），二维码扫描后确认登录，则 302 重定向回本服务回调地址（即上一步 redirect_url），携带微信临时 code
4. redirect_url 进入后端，取出 code 从微信服务器置换用户身份信息，设置响应 Cookie，并 302 重定向到业务页面
5. 业务页面登录态正常访问
